أريدك أن تقوم بتحديث شامل لمشروع ARKAN AI على ثلاثة مستويات:

إصلاح استهلاك مفاتيح Gemini API بحيث لا تُستهلك الكوتا إلا في الأدوات التي تحتاج فعلاً إلى الذكاء الاصطناعي.

تحسين واجهة العرض (UI) للصفحة الرئيسية للأدوات (Tools Hub) لتصبح ثلاثية الأبعاد وبثيم فرعوني حديث.

تحسين لوحة التحكم الإدارية (Admin Dashboard في /admin/keys) لتكون ثلاثية الأبعاد واحترافية، مع إضافة قسم لعرض عدد الأجهزة/الجلسات النشطة حاليًا وبياناتها الأساسية، مع بقاء ربط الداشبورد بكل بيانات الموقع.

نفّذ كل الخطوات التالية بدون تغيير منطق العمل الأساسي للأدوات، وبدون تعطيل أي أداة حالية، مع الحفاظ على جميع الـ routes والـ endpoints.

أولًا: إصلاح استهلاك مفاتيح Gemini API ومنع الحرق غير الضروري

حاليًا مفاتيح Gemini تُستنزف بسرعة حتى مع استخدام بسيط، لأن بعض الأدوات التي لا تحتاج الذكاء الاصطناعي تقوم باستدعاء Gemini بالخطأ (خصوصًا عند تحميل أو قص فيديوهات / ملفات صوتية).

مطلوب ما يلي:

1. مراجعة كل الأماكن التي يتم فيها استدعاء Gemini

ابحث في المشروع عن كل استخدام لـ:

genai.GenerativeModel

وأي دالة تغلف استدعاء Gemini (مثل: call_gemini_text, call_gemini_vision, transcribe_audio_with_gemini… إلخ).

أنشئ نقطة مركزية واضحة لاستدعاء Gemini (إن لم تكن موجودة بالفعل)، أو استخدم النقاط الموجودة حاليًا، واعتبرها المصدر الوحيد لاستدعاء Gemini، بحيث يمكننا مراقبة وحماية الاستهلاك منها.

2. حدد الأدوات المسموح لها باستخدام Gemini فقط

يُسمح باستخدام Gemini في الأدوات التالية فقط:

تحويل الصوت الحي إلى نص (live mic STT)

تحويل ملف صوتي إلى نص (Audio File → Text)

تحويل فيديو إلى نص (Video → Text)

كشف الأنمي من الصورة (Anime Identifier)

كشف البودكاست / الشخصية من صورة أو من نص مستخرج من الصوت (Podcast/Identity Finder)

أداة التنسيق الذكي لملفات Word/PDF (Smart Formatter) عندما تستخدم Gemini لتحليل/تنسيق النص

أي أداة خارج هذه القائمة لا يجب أن تستدعي Gemini إطلاقًا.

3. الأدوات التي يجب أن تعمل بدون أي استدعاء لــ Gemini

تأكد أن الأدوات التالية تعتمد فقط على المعالجة المحلية (ffmpeg, yt-dlp, pydub, tesseract…) ولا تستدعي Gemini نهائيًا:

أداة قص مقاطع يوتيوب (YouTube Cutter & Downloader)

تحميل الفيديو/الصوت + قص الجزء المطلوب محليًا فقط.

أداة تحميل الفيديو من أي موقع + التحويل لصوت (Universal Downloader & Converter)

تحميل وتحويل بصيغ مختلفة محليًا فقط.

أداة فصل الموسيقى عن الصوت (Vocal Remover)

فصل الصوت/الموسيقى باستخدام أدوات صوتية محلية فقط.

أي أداة OCR تعتمد على Tesseract فقط (إن وُجدت منفصلة عن أنمي/بودكاست).

أي أداة pure-conversion (PDF↔Word) لا تحتاج ذكاء اصطناعي.

يجب إزالة أو تعطيل أي استدعاء لـ Gemini من هذه الأدوات تمامًا.

4. تأكد أن كل عمليات “تحميل/قص/تحويل صيغة” لا تستدعي Gemini

راجع كل الـ routes التي تتعامل مع:

تحميل فيديو/صوت

قص جزء من الفيديو أو الصوت

تحويل صيغة ملف

تأكد أن:

لا يتم استدعاء أي دالة من نوع call_gemini_* فيها.

لا توجد middlewares أو hooks ترسل هذه الملفات أو الـ metadata إلى Gemini بلا داعٍ.

5. تبسيط مسار استدعاء Gemini وتقليل الاستهلاك

تأكد أن كل طلب إلى Gemini:

يستخدم مفتاحًا واحدًا في المحاولة الأساسية، ومع حد أقصى مفتاحين لكل طلب (كما في نظام 50-key والـ cooldown الحالي).

لا توجد retries إضافية داخل الأدوات نفسها فوق نظام الـ 2-key-max retry الموجود.

لو يوجد أي retry إضافي على مستوى الأدوات، اعتمد على منطق إدارة المفاتيح المركزي فقط.

6. Logging واضح لمراقبة استدعاءات Gemini

في الطبقة المركزية لاستدعاء Gemini، أضف logging يتضمن:

نوع الطلب (Text / Audio / Video / Vision)

اسم الأداة أو الـ route التي جاء منها الطلب

الهدف: التأكد لاحقًا في الـ logs أن أدوات:

Downloader

Cutter

Vocal Remover
لا ترسل أي طلبات لـ Gemini.

ثانيًا: تحديث واجهة القوائم الرئيسية للأدوات (Tools Hub) – 3D + ثيم فرعوني حديث

هذه هي صفحة القوائم الرئيسية للأدوات. أريد:

1. تخطيط عرض حديث

Desktop:

استخدم Grid من الكروت (3×3 أو 4×2 حسب عدد الأدوات)، بحيث تكون الكروت جنب بعض في صفوف متناسقة.

Tablet:

عمودان (2 columns).

Mobile:

عمود واحد مع المحافظة على الشكل الثلاثي الأبعاد والهوية البصرية بدون خروج عناصر أو Scroll أفقي.

2. كروت ثلاثية الأبعاد (3D Cards)

كل أداة داخل بطاقة 3D:

استخدم perspective مع transform: rotateX/rotateY على الـ hover لعمل تأثير tilt لطيف.

أضف box-shadow قوي ناعم + glow خفيف حول حدود الكارت.

الكارت بالكامل يكون clickable ويفتح صفحة الأداة المرتبطة كما هو الآن.

3. ثيم فرعوني حديث

الخلفية:

حافظ على الخلفية الفرعونية (الجدار/المعبد) أو استبدلها بخلفية تناسب الشكل، مع overlay غامق (dark gradient) لتحسين تباين النص.

الألوان:

ذهبي فرعوني

أزرق فيروزي

بنفسجي/نيون

الأيقونات:

استخدم SVGs أو أشكال بسيطة بروح فرعونية مستقبلية (عين حورس حديثة، بردية minimal، عمود فرعوني، إلخ).

ضع الأيقونة داخل دائرة مضيئة أعلى الكارت، مع glow وتأثير hover بسيط.

4. أنيميشن

أضف transition ناعم (0.2–0.3s) للـ hover على الكروت والأيقونات.

يمكن إضافة Animation لظهور الكروت عند تحميل الصفحة (fade-in + slight move-up).

5. Responsiveness

تأكد من:

عدم وجود scroll أفقي.

النصوص والأزرار واضحة ومقروءة على الموبايل.

مساحات لمس كافية (tap targets) على الشاشات الصغيرة.

6. الحفاظ على المنطق

لا تغيّر:

أسماء الـ routes

روابط فتح الأدوات

منطق الـ backend

كل التغييرات تكون في:

HTML / CSS

JS الخاص بالأنيميشن والـ UI فقط.

ثالثًا: تحديث لوحة التحكم الإدارية (Admin Dashboard – /admin/keys) + إضافة مراقبة الأجهزة المتصلة

لوحة /admin/keys تدير مفاتيح Gemini وتعرض الإحصائيات. أريد:

1. تصميم عام ثلاثي الأبعاد فرعوني حديث

اجعل الواجهة Dark Mode متناسقة مع ثيم ARKAN AI:

خلفية داكنة مع لمسة فرعونية خفيفة (نقوش أو patterns بسيطة).

Header واضح يحتوي على:

عنوان اللوحة (مثلاً: لوحة تحكم مفاتيح Gemini – ARKAN AI)

زر للعودة إلى صفحة الأدوات الرئيسية.

2. كروت إحصائيات (Summary Cards) ثلاثية الأبعاد

في أعلى اللوحة، ضع كروت 3D تعرض على الأقل:

إجمالي عدد المفاتيح.

عدد المفاتيح النشطة.

عدد المفاتيح في Cooldown.

عدد المفاتيح المعطلة يدويًا.

عدد الطلبات اليوم.

عدد أخطاء 429 اليوم.

كل كارت:

له أيقونة مناسبة.

لون مميز.

تأثير 3D + Glow خفيف عند الـ hover.

3. الرسوم البيانية (Charts)

اعرض على الأقل:

رسم بياني (Line أو Bar) لعدد الطلبات لكل ساعة خلال آخر 24 ساعة.

رسم بياني لتوزيع أنواع الطلبات (Text / Vision / Audio / Video).

إن أمكن: رسم لأكثر المفاتيح استخدامًا.

تأكد أن:

البيانات تأتي من الجداول/الـ logs الحقيقية الموجودة في قاعدة البيانات.

الثيم البصري متناسق مع بقية اللوحة (ألوان نيون على خلفية داكنة).

4. جدول المفاتيح (Keys Table) محسّن

اعرض جدولًا يتضمن لكل مفتاح:

Label/Index (مثل GEMINI_KEY_1)

الحالة (Active / Cooldown / Disabled)

عدد الاستخدامات

عدد مرات الـ Cooldown

آخر وقت استخدام

ألوان للحالات:

أخضر → Active

أصفر/برتقالي → Cooldown

رمادي/أحمر باهت → Disabled

أضف:

شريط بحث لتصفية المفاتيح.

فلاتر (All / Active / Cooldown / Disabled).

إمكانية ترتيب الأعمدة (sort) حسب عدد الاستخدامات وآخر استخدام.

حافظ على زر التفعيل/التعطيل اليدوي لكل مفتاح (Toggle)، مع تصميم Neon واضح، وربطه بنفس منطق الـ backend الحالي.

5. قسم “آخر الأحداث” (Recent Activity) – إن توافرت البيانات

إن كانت هناك بيانات في قاعدة البيانات أو في الـ logging:

اعرض جدولًا صغيرًا لآخر X طلبات، يظهر فيها:

وقت الطلب

نوع الطلب (Text/Audio/Video/Vision)

المفتاح المستخدم (index فقط)

نتيجة الطلب (نجاح / 429 / Error)

6. قسم جديد: الأجهزة/الجلسات المتصلة حاليًا (Active Devices / Sessions)

أريد إضافة قسم مخصص في الداشبورد يعرض:

عدد الأجهزة/الجلسات النشطة الآن:

اعتبر الجلسة "نشطة الآن" إذا كان آخر طلب منها خلال آخر 5–10 دقائق.

اعرض رقمًا واضحًا في كارت مستقل (مثلاً: “الأجهزة المتصلة الآن: 3”).

مصدر بيانات الجلسات:

أنشئ آلية لتسجيل الجلسات في قاعدة البيانات (أو جدول جديد مثل sessions أو active_sessions)، تحتوي على الحقول التالية أو ما يعادلها:

session_id أو token (يمكن ربطه بالـ session الحالية إذا كان Flask يستخدم sessions).

user_id (إن وجد مستخدم مسجّل دخول، أو NULL لو زائر).

IP address.

User-Agent (لاستخلاص نوع الجهاز والمتصفح).

نوع الجهاز المستنتج (Mobile / Desktop / Tablet) إن أمكن من الـ User-Agent.

وقت أول زيارة (first_seen).

وقت آخر نشاط (last_seen).

في كل طلب من المستخدم (مثلاً في before_request):

حدّث أو أنشئ سجل للجلسة الحالية بالـ IP و User-Agent و session_id.

حدث last_seen في كل طلب، بدون عمل queries ثقيلة.

عرض بيانات الأجهزة في مربع أو كارت خاص:

أنشئ جزءًا في لوحة التحكم يعرض جدولًا صغيرًا أو Panel بعنوان مثل:

“الأجهزة المتصلة الآن”

اعرض فيه لكل جلسة نشطة (آخر نشاط خلال آخر 5–10 دقائق):

IP (أو جزء منه لو أردت إخفاءه جزئيًا).

نوع الجهاز (Mobile / Desktop / Tablet) إن أمكن.

المتصفح (من الـ User-Agent إن أمكن).

user_id أو اسم المستخدم إن كان مسجّل دخول (لو نظام المستخدمين موجود).

آخر وقت نشاط (last_seen).

اجعل هذا القسم:

في Panel مستقلة أسفل الـ Summary Cards أو بجانب الرسم البياني.

بشكل 3D ونفس ثيم اللوحة (Dark + Neon).

خصوصية وأداء:

لا تستخدم أي خدمات خارجية ثقيلة لتحليل IP (يمكن الاكتفاء بالـ IP و User-Agent كما هما بدون GeoIP).

اجعل جدول الجلسات يُحدّث بكفاءة، وتجنّب الاستعلامات المكثفة.

اعتبر الجلسات المنتهية هي التي لم تتفاعل لوقت أطول (مثلاً أكثر من 30–60 دقيقة)، ويمكن تجاهلها في قائمة “الأجهزة المتصلة الآن”.

7. Auto-refresh

حافظ على Auto-refresh معقول (مثل كل 30 ثانية) لتحديث:

الإحصائيات.

الرسوم البيانية.

عدد الجلسات النشطة.

اجعل التحديث جزئيًا (AJAX أو fetch) وليس إعادة تحميل الصفحة بالكامل.

8. حماية الداشبورد وربطها بالموقع

تأكد أن:

/admin/keys ما زال محميًا بنظام تسجيل الدخول الحالي (Admin فقط).

لا يوجد رابط ظاهر للوحة في واجهة المستخدم العادية.

تأكد أن:

كل الأزرار (تفعيل/تعطيل مفاتيح، التحديث التلقائي) تؤثر فعليًا في قاعدة البيانات والمنطق الخلفي.

لوحة التحكم تعكس الحالة الحقيقية للمفاتيح والجلسات والاستهلاك.

9. اختبارات نهائية

بعد الانتهاء:

اختبر:

أدوات Downloader/Cutter/Vocal Remover:

تعمل بالكامل بدون أي استدعاء لـ Gemini (تأكد من ذلك من خلال الـ logs).

أدوات STT / Formatter / Anime / Podcast:

ما زالت تستعمل Gemini بشكل طبيعي.

افتح الموقع من أجهزة/متصفحات مختلفة:

تأكد أن عدّاد الأجهزة المتصلة يعكس العدد الحقيقي.

تأكد أن جدول الأجهزة/الجلسات يعرض بيانات منطقية (IP، نوع الجهاز، آخر نشاط…).

تأكد أن واجهة القوائم الرئيسية والداشبورد:

ثلاثية الأبعاد.

بثيم فرعوني حديث.

متجاوبة (Responsive).

بدون أخطاء في الـ console أو الـ server logs.

نفّذ كل ما سبق مباشرة في ملفات المشروع، ولا تعرض الأكواد في الرد، فقط طبّق التعديلات كما هو موصوف.