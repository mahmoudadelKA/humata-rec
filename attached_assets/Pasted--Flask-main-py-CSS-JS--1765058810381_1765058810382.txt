أريدك أن تقوم الآن بإعادة تنظيم جزء من مشروع Flask الحالي (main.py + القوالب + الـ CSS/JS) لتنفيذ هذه النقاط بالتفصيل، بدون تغيير الـ API routes الأساسية أو تعطيل الأدوات الموجودة:

1️⃣ استبدال نظام القائمة الجانبية بـ “صفحة أدوات” مستقلة (Tools Hub)

أنشئ صفحة HTML/Template جديدة تُسمّى مثلًا “صفحة الأدوات” أو “Tools Hub”، تظهر بعد صفحة الترحيب/الصفحة الرئيسية.

هذه الصفحة يجب أن تحتوي على جميع أدوات ARKAN AI على شكل شبكة بطاقات (Grid of cards):

لكل أداة:

أيقونة فرعونية مميزة

اسم الأداة

وصف قصير جدًا لسطر أو سطرين

زر أو رابط يفتح نفس الـ route الحالي للأداة (لا تغيّر أسماء المسارات في Flask).

اجعل تصميم الصفحة متجاوبًا:

على الموبايل: عمود واحد أو عمودان.

على التابلت والكمبيوتر: 2–4 أعمدة حسب العرض.

اجعل الانتقال الطبيعي في الموقع كالتالي:

صفحة الدخول/الترحيب → زر “ابدأ” أو ما يعادله → صفحة الأدوات (Tools Hub) → صفحة الأداة المختارة.

2️⃣ إضافة زر رجوع ثابت في جميع صفحات الأدوات

في كل صفحة أداة (تحويل الصوت لنص، قص يوتيوب، تحويل PDF، فصل الموسيقى… إلخ):

أضف زر واضح وثابت على يسار الشاشة (position ثابت)، يحتوي على:

أيقونة فرعونية بسيطة (مثلاً هرم صغير، عين حورس، مفتاح عنخ… إلخ).

نص مثل: “رجوع للأدوات” أو “العودة لصفحة الأدوات”.

عند الضغط عليه يعيد المستخدم مباشرة إلى صفحة الأدوات (Tools Hub).

هذا الزر يجب أن:

يظهر على الموبايل والكمبيوتر معًا، لكن بحجم يناسب كل شاشة.

لا يظهر داخل صفحة الأدوات نفسها.

3️⃣ إلغاء القائمة الجانبية القديمة (Sidebar) بالكامل

احذف أو عطّل أي HTML يخص الـ Sidebar:

عناصر القائمة الجانبية نفسها.

زر “الهامبرجر” أو أي زر كان يفتحها.

احذف أو عطّل أي JavaScript كان مسئولًا عن فتح/غلق الـ Sidebar أو عن التعامل مع اللمس داخلها.

تأكد أنه لا يوجد أي كود أو CSS متبقّي متعلق بالـ Sidebar يمكن أن يسبب تعارض أو استهلاك موارد بلا داعٍ.

بعد الحذف، تأكد أن الملاحة الوحيدة بين الأدوات تتم عبر:

صفحة الأدوات (Tools Hub).

زر الرجوع في كل صفحة أداة.

بهذا الشكل نُنهى تمامًا مشكلة اللمس والسحب في القائمة الجانبية.

4️⃣ تحسين واجهة الموبايل والتابلت في كل الصفحات

اضبط الـ CSS بحيث:

لا يوجد أي Scroll أفقي على الشاشات الصغيرة.

كل العناصر داخل الحاويات (containers) لا تتخطى عرض الشاشة.

خصوصًا في قسم تحويل الصوت إلى نص:

صغّر حجم عنوان الأداة ووصفها على الشاشات الصغيرة مع Media Queries مناسبة.

صغّر حجم الأزرار الدائرية (تسجيل عادي / استماع مستمر) بحيث تناسب الموبايل لكن تظل واضحة وسهلة الضغط.

تأكد أن أزرار “نسخ النص / تحميل / حذف” تظهر في شبكة مرتبة على الموبايل (صف أو صفين) مع مسافات متساوية.

صندوق النص الناتج يكون بعرض مريح مع هوامش واضحة من الجانبين.

طبّق نفس فلسفة الـ responsive على باقي الصفحات دون تغيير الشكل العام لنسخة الكمبيوتر.

5️⃣ الأيقونات الفرعونية في كل الأدوات

استبدل الأيقونات الحالية في كل الصفحات (الهيدر، الأزرار، عناوين الأدوات، أزرار التحكم، عناصر صفحة الأدوات الجديدة) بأيقونات بطابع فرعوني، مثال لا حصري:

عين حورس، هرم، بردية، ريشة كتابة، مفتاح عنخ، قرص الشمس، أفعى كوبرا، تمثال فرعوني… إلخ.

اجعل هناك نظام تصميم موحّد للأيقونات:

حجم متقارب في كل مكان.

ألوان متناسقة مع ثيم الموقع (ذهبي/نيون مع خلفية المعابد).

محاذاة سليمة مع النص بجوارها (وسطية رأسية وأفقية).

على الكمبيوتر يمكنك استخدام نسخة أكثر تفصيلاً من الأيقونات (SVGs بتوهج/Glow)، وعلى الموبايل نسخة أبسط وواضحة.

طبّق هذه الأيقونات في:

صفحة الأدوات (Tools Hub).

عناوين الصفحات.

أزرار تسجيل الصوت والاستماع المستمر.

أزرار التحكم في النص (نسخ/حذف/تحميل).

6️⃣ إصلاح مشكلة زر الميكروفون (التسجيل مرتين/بسرعة)

راجع JavaScript الذي يتحكم في:

بدء التسجيل.

إيقاف التسجيل.

الإرسال للـ backend.

تأكد من:

وجود مستمع أحداث واحد فقط لكل زر (لا يوجد تكرار بين onclick و addEventListener و touchstart لنفس الزر).

عدم إنشاء أكثر من MediaRecorder أو Stream لنفس الزر في نفس الوقت.

عند الضغط على الزر يتم:

تعطيل الزر مؤقتًا أثناء بدء التسجيل أو الإرسال لمنع الضغط المتكرر.

الهدف: الضغط مرة واحدة = تسجيل واحد بسرعة طبيعية، بدون مضاعفة أو تكرار.

7️⃣ إدارة مفاتيح Gemini (عدد 12 مفتاح) بنظام تبديل عادل + تبريد (Cooldown)

أريدك أن تعيد تصميم كود إدارة مفاتيح Gemini بالكامل بطريقة واضحة وموحدة، بحيث:

أ) قراءة وتجميع المفاتيح

اجمع كل المفاتيح التي في متغيرات البيئة:

GEMINI_KEY_1 إلى GEMINI_KEY_11

GEMINI_API_KEY (ليكون المفتاح رقم 12 أو الأساسي)

ضعهم في قائمة مرتبة واحدة (مثل قائمة GEMINI_KEYS)، مع تجاهل أي متغير غير مُعرّف.

ب) نظام تدوير المفاتيح (Round-Robin)

استخدم مؤشر عام (global state) يحتفظ برقم آخر مفتاح تم استخدامه.

أنشئ منطق (دالة أو ما يعادلها) عندما تحتاج مفتاحًا جديدًا:

تتحرك على المفاتيح بنظام round-robin:

المفتاح 1 ثم 2 ثم 3 … حتى 12 ثم تعود للأول.

كل استدعاء جديد لـ Gemini يجب أن يبدأ من المفتاح التالي، وليس نفس المفتاح السابق.

ج) نظام Cooldown لكل مفتاح

عندما يعود استدعاء Gemini بخطأ واضح من نوع:

429

quota exceeded

rate limit reached
اعتبر أن هذا المفتاح استُنفِد (exhausted) مؤقتًا.

سجّل للمفتاح توقيت انتهاء التبريد (Cooldown) لمدة ساعة تقريبًا.

أثناء اختيار مفتاح جديد:

تجاوز أي مفتاح ما زال داخل فترة التبريد.

إذا انتهت الفترة، أعده للدورة بشكل طبيعي.

د) آلية المحاولة (Retry) والتبديل بين المفاتيح

عند استدعاء Gemini (نصي، Vision، أو Transcription):

جرّب مفتاحًا واحدًا:

لو نجح → استخدم النتيجة ودوّن في الـ logs أي مفتاح استخدم.

لو فشل بخطأ quota/rate → ضع هذا المفتاح في حالة Cooldown ثم جرّب المفتاح التالي مباشرة.

لو فشل بخطأ آخر (غير متعلق بالكوتا) → سجّل الخطأ وتوقّف عن تدوير المفاتيح (لأن المشكلة ليست في الكوتا).

حدّد عددًا أقصى للمحاولات في الطلب الواحد يساوي تقريبًا عدد المفاتيح المتاحة (مثلاً مرة واحدة لكل مفتاح).

هـ) التصرف عند استنفاد جميع المفاتيح

إذا وجدت أنه لا يوجد أي مفتاح غير موجود في فترة تبريد (أي أن جميع المفاتيح مستنفدة حاليًا):

لا تجعل التطبيق ينهار أو يرفع Exception غير مفهوم في الواجهة.

بدلًا من ذلك:

أعِد للمستخدم ردًّا مناسبًا باللغة العربية في الواجهة الأمامية (رسالة خطأ ودية)، مثل:

“عذرًا، تم استنفاد حصة مفاتيح الذكاء الاصطناعي مؤقتًا. يرجى المحاولة بعد قليل.”

في الـ logs، سجّل تحذير واضح من نوع WARNING يوضح أن جميع المفاتيح في حالة تبريد ومعه توقيت أقرب مفتاح سيعود للعمل.

تأكد أن استنفاد مفاتيح Gemini لا يوقف بقية الأدوات في الموقع (مثل أدوات القص، التحميل، تحويل PDF… إلخ)، وإنما يؤثر فقط على العمليات التي تعتمد على Gemini.

و) تطبيق النظام الجديد على جميع نقاط استخدام Gemini

طبّق المنطق السابق في:

استدعاءات النص (Text)

استدعاءات الرؤية (Vision)

جزء transcribe_audio_with_gemini الخاص بتحويل الصوت إلى نص

أزل أي منطق قديم لإدارة المفاتيح (مثل دوال get_balanced_key_index أو key_usage_count السابق)، واستبدله بالنظام الجديد الذي يعتمد على round-robin + cooldown.

8️⃣ اختبار شامل بعد التعديلات

بعد تنفيذ كل ما سبق، اختبر الآتي من داخل المشروع:

التدفق:

الدخول → صفحة الأدوات (Tools Hub) → اختيار أداة → استخدام زر الرجوع → العودة لصفحة الأدوات.

على الموبايل:

تأكد من عدم وجود Sidebar.

صفحة الأدوات تظهر كاملة، وكل كارت أداة واضح وسهل الضغط.

أزرار المايك تعمل مرة واحدة فقط بدون تسجيل مضاعف.

جرّب استهلاك مفاتيح Gemini (مثل تشغيل عدة طلبات متتالية حتى تظهر رسائل quota في الـ logs) وتأكد أن:

الكود يبدأ في التبديل بين المفاتيح واحدًا تلو الآخر.

عند انتهاء جميع المفاتيح فعليًا، تظهر رسالة ودية للمستخدم بدل انهيار الأداة.

أريد في النهاية:

واجهة نظيفة بدون قائمة جانبية، تعتمد على صفحة أدوات مركزية + زر رجوع.

أيقونات فرعونية موحّدة في كل الصفحات.

أدوات الصوت تعمل بدون تكرار في التسجيل.

ونظام مفاتيح Gemini ذكي، يلف على كل المفاتيح الـ 12 بالتناوب، ويتعامل مع استنفاد الكوتا دون أن يوقف الموقع أو يسبب أخطاء حمراء مستمرة في الـ logs.