أريدك أن تراجع وتعدّل مشروعي الحالي (تطبيق Flask في الملف main.py + Dockerfile) ليكون أخف بكثير في استهلاك الذاكرة وأعلى في الاعتمادية، مع تحسين شامل لأداة قص فيديو يوتيوب، وإضافة ميزة اختيار جودة الفيديو ونوع التحميل (فيديو أو صوت فقط)، وكذلك تحسين واجهة الموقع على شاشات الموبايل والتابلت، وإصلاح مشكلة القائمة الجانبية التي لا تستجيب، وإصلاح مشكلة زر الميكروفون الذي يسجّل الصوت مرتين وبسرعة. كل ذلك مع الحفاظ على نفس شكل الموقع وتجربة الاستخدام قدر الإمكان.

التعديلات المطلوبة بالتفصيل:

1️⃣ ضبط Dockerfile و Gunicorn

أبقِ جميع إعدادات Dockerfile كما هي (قاعدة الصورة، تنصيب ffmpeg و tesseract، تثبيت الحزم من requirements.txt).

تأكد أن مجلد العمل مضبوط على ‎/app‎ ويتم نسخ requirements.txt ثم باقي ملفات المشروع كما هو حاليًا.

احذف أي سطر يعرّف بورت ثابت (مثل سطور EXPOSE لبورت معيّن)، لأن الخدمة تعمل على Render ويجب الاعتماد فقط على متغيّر البيئة PORT.

عدّل سطر تشغيل التطبيق بحيث:

يتم تشغيل Gunicorn على تطبيق Flask المعرّف في main.py بالاسم app (أي باستخدام main:app).

يتم الربط على العنوان 0.0.0.0 وعلى البورت القادم من متغيّر البيئة PORT فقط، بدون أرقام ثابتة داخل الملف.

يكون عدد الـ workers واحد فقط، وعدد الـ threads واحد فقط، مع وقت انتظار (timeout) كبير يكفي للطلبات الطويلة (حوالي 1800 ثانية).

الهدف هنا هو تشغيل نسخة واحدة فقط من التطبيق لتقليل استهلاك الذاكرة، مع دعم الطلبات الطويلة.

2️⃣ تحسين شامل لأداة قص فيديو يوتيوب + اختيار الجودة + نوع التحميل

أريد إعادة تصميم منطق أداة قص يوتيوب في backend (داخل main.py) مع الحفاظ على نفس الواجهة الأمامية قدر الإمكان، مع إضافة ما يلي:

أ) دالة للحصول على الجودات المتاحة من يوتيوب

أنشئ دالة في الـ backend تستخدم yt_dlp فقط لجلب قائمة الفورمات/الجودات المتاحة لفيديو يوتيوب (بدون تحميل الفيديو).

الدالة يجب أن:

تستقبل رابط الفيديو من يوتيوب.

تستدعي yt_dlp لاسترجاع جميع الفورمات المتاحة.

ترجع قائمة مبسّطة يمكن إرسالها للواجهة الأمامية في شكل JSON، تحتوي مثلًا على:

الدقة (360p / 480p / 720p / 1080p …)

نوع الفورمات (فيديو مع صوت، فيديو فقط، صوت فقط)

حجم تقريبي إن أمكن

تستخدم ملف cookies.txt إن كان موجودًا لتفادي مشاكل 403.

أنشئ مسار (route) في Flask مرتبط بزر "جلب المعلومات" الموجود في واجهة قص يوتيوب، بحيث يعيد هذه القائمة للواجهة الأمامية لتعبئة قائمة الجودة ونوع التحميل.

ب) دالة تحميل فيديو/صوت من يوتيوب

أنشئ دالة مسؤولة عن تحميل الملف من يوتيوب إلى ملف مؤقت على القرص باستخدام yt_dlp، بدون تخزين البيانات في الذاكرة.

الدالة يجب أن:

تستقبل: رابط الفيديو، الجودة المطلوبة، ونوع التحميل (فيديو أو صوت فقط).

تختار الفورمات المناسب من yt_dlp بناءً على القيم التي ترجع من دالة الجودات، بحيث:

إذا كان النوع "فيديو": تحميل ملف يحتوي على فيديو وصوت بصيغة mp4 وبأقرب جودة ممكنة للجودة المطلوبة.

إذا كان النوع "صوت فقط": تحميل أفضل فورمات صوت متاحة بحجم معقول، ثم يمكن لاحقًا تحويلها لصيغة مناسبة (مثل mp3) بواسطة ffmpeg إذا لزم.

تمنع تحميل playlists (فيديو واحد فقط).

تستخدم cookies.txt إن وجد.

تحفظ الملف الناتج في مجلد مؤقت وتعيد المسار الكامل له.

ج) دالة قص الملف باستخدام ffmpeg

أنشئ دالة مساعدة لقص الفيديو أو الصوت تعمل بالكامل على مستوى الملفات (تتعامل مع المسارات على القرص فقط).

الدالة تستقبل:

مسار الملف الذي تم تحميله.

وقت البداية ووقت النهاية بنفس تنسيق الواجهة (مثل hh:mm:ss).

نوع التحميل (فيديو أو صوت فقط).

استخدم ffmpeg عبر استدعاء سطر الأوامر من خلال subprocess، مع مراعاة:

استخدام خيارات القص المناسبة للبداية والنهاية.

إذا كان النوع "فيديو": استخدام قص مباشر بدون إعادة ترميز قدر الإمكان لتقليل استهلاك المعالج والذاكرة.

إذا كان النوع "صوت": استخراج مقطع صوت فقط من الملف، مع استخدام ترميز صوت مناسب وخفيف.

تحفظ النتيجة في ملف جديد داخل مجلد مؤقت، وتعيد المسار الكامل للملف الناتج.

د) تعديل الراوت الرئيسية لأداة القص

عدّل الراوت التي تُستخدم لقص الفيديو بحيث:

تقرأ من الطلب:

رابط الفيديو

وقت البداية ووقت النهاية

الجودة المختارة

نوع التحميل (فيديو أو صوت فقط)

تستدعي دالة التحميل مع تمرير الجودة والنوع.

تستدعي دالة القص للحصول على الملف النهائي.

ترجع الملف النهائي للمستخدم كتحمـيل (attachment) مع نوع المحتوى المناسب:

mp4 عند اختيار فيديو

امتداد صوت مناسب عند اختيار صوت فقط

تضيف منطقًا واضحًا لتنظيف الملفات المؤقتة بعد إرسال الرد (حذف ملف الفيديو الأصلي وملف المقطع النهائي) باستخدام آلية مناسبة مثل after_this_request أو ما يعادلها.

تضيف تسجيلات (logging) للخطوات الأساسية: بدء جلب الجودات، بدء التحميل، الانتهاء من التحميل، بدء القص، الانتهاء من القص، حذف الملفات المؤقتة.

هـ) دعم الجودة ونوع التحميل في الواجهة الأمامية

استخدم الراوت الجديدة الخاصة بجلب الجودات لملء قائمة اختيار الجودة في واجهة قص الفيديو (Select أو ما يعادلها) بنفس تصميم الموقع الحالي.

أضف في الواجهة الأمامية اختيارًا لنوع التحميل (فيديو / صوت فقط) مرتبط بالحقول التي يستقبلها الـ backend.

على مستوى الـ backend، تأكد من التعامل مع هذه الحقول بشكل صحيح، وتحديد قيم افتراضية مناسبة في حالة عدم وجود اختيار من المستخدم (مثلاً جودة متوسطة ونوع تحميل فيديو).

3️⃣ تحسين استهلاك الذاكرة في باقي الأدوات

راجع الأكواد التي تستخدم ملفات صوت أو فيديو أو صور (مثل أدوات فصل الصوت، تحويل الفيديو إلى نص، إلخ) وقلّل قدر الإمكان من الاحتفاظ بكائنات كبيرة في الذاكرة.

استخدم العمل على الملفات الموجودة على القرص بدلًا من تخزين البيانات في متغيرات كبيرة أو تحويلها إلى نصوص base64 ضخمة.

بعد الانتهاء من أي معالجة لملفات كبيرة، تخلّص من المراجع لهذه الكائنات، ونظّف الملفات المؤقتة من المجلد المؤقت.

الهدف أن يتعامل التطبيق مع الملفات الكبيرة بأقل استهلاك ممكن للرام، مع الحفاظ على نفس النتائج للمستخدم.

4️⃣ الحفاظ على سلوك الموقع

لا تغيّر تصميم الواجهة أو أسماء المسارات أو أسماء الحقول في الطلبات إلا قدر ما يلزم لدعم:

اختيار الجودة

اختيار نوع التحميل

تأكد أنّ:

أداة قص يوتيوب ما زالت تعمل كما كانت، مع إضافة خيارات الجودة ونوع التحميل.

بقيّة الأدوات الأساسية تعمل بنفس الشكل السابق من وجهة نظر المستخدم، مع فرق وحيد هو تحسّن الأداء وتقليل الأعطال.

5️⃣ (جديد) تحسين واجهة الموقع على شاشات الموبايل والتابلت

أريد منك تحديث الواجهة الأمامية لتكون متجاوبة بشكل ممتاز مع شاشات الموبايل والتابلت، وحل المشاكل التالية تحديدًا:

بعض العناصر (النصوص والأزرار والبطاقات) لا تظهر بشكل صحيح على الموبايل: الأحجام كبيرة أكثر من اللازم، أو المسافات غير مناسبة، أو العناصر تخرج خارج الشاشة.

تأكد من:

ضبط الـ layout باستخدام تقنيات مناسبة (مثل grid أو flex أو media queries) بحيث يتم تصغير البطاقات والأزرار والخطوط بشكل منطقي على الشاشات الصغيرة والمتوسطة.

جعل الأقسام تتكدّس عموديًا على الموبايل بدلًا من الترتيب الأفقي إذا كان هذا يسبب مشكلة في العرض.

اختبار التصميم على نقاط كسر شاشة شائعة (مثل عرض موبايل صغير، وعرض تابلت)، وضبط الأحجام والمسافات بحيث تبقى القراءة والاستخدام مريحة.

الحفاظ على هوية التصميم الحالية (الألوان النيون، الخلفيات، الجو العام)، مع تحسين التباين ووضوح النصوص على الشاشات الصغيرة.

تأكد أيضًا من أن الأزرار المهمة (مثل زر الميكروفون، زر القائمة، أزرار التحميل، إلخ) واضحة وسهلة الضغط بالإصبع، مع مساحة كافية حولها.

6️⃣ (جديد) إصلاح مشكلة زر القائمة الجانبية (الـ Sidebar / Menu)

على شاشات الموبايل، زر القائمة الجانبية لا يفتح القائمة ولا يستجيب. أريد منك:

مراجعة كود الواجهة الأمامية (HTML/CSS/JS) المسؤول عن القائمة الجانبية وزر فتحها وإغلاقها.

التأكد من أنّ:

زر القائمة (الآيكونة الموجودة في الأعلى) مربوط فعليًا بالـ event المناسب (click أو touch) وأنه لا يوجد تضارب بينهما.

لا يوجد عنصر آخر فوق الزر (مثلاً overlay أو عنصر بـ z-index أعلى) يمنع استقبال الضغط.

عند الضغط على الزر، تفتح القائمة الجانبية بانسيابية، وتُغلق عند الضغط على زر الإغلاق أو عند الضغط خارج القائمة أو على أحد الروابط بداخلها، حسب التصميم المناسب.

القائمة لا تسبب منع التمرير في كل صفحة إلا عند فتحها، ويتم السماح بالتمرير مرة أخرى عند إغلاقها.

إذا كان هناك كود يضيف أكثر من مستمع للأحداث (event listeners) لنفس الزر ويتسبب في سلوك غير متوقع، قم بتحديثه بحيث يكون هناك منطق واحد وواضح لفتح وإغلاق القائمة.

7️⃣ (جديد) إصلاح مشكلة زر الميكروفون الذي يسجّل مرتين وبسرعة

في قسم تحويل الصوت إلى نص، هناك مشكلة أن زر الميكروفون يقوم بالتسجيل مرتين أو يبدو أنّه يرسل الصوت بسرعة/مرّتين عند الضغط. أريد منك:

مراجعة كود الجافاسكربت المسؤول عن:

بدء التسجيل من الميكروفون.

إيقاف التسجيل.

إرسال الصوت إلى الـ backend أو إلى أي خدمة ذكاء اصطناعي.

تأكد من:

عدم وجود مستمعي أحداث مكررين لنفس الزر (مثل إضافة event listeners داخل دوال يتم استدعاؤها أكثر من مرة).

عدم استخدام كل من click و touchstart بطريقة تؤدي إلى تشغيل الحدث مرتين لنفس النقرة على الموبايل. إذا لزم الأمر، استخدم طريقة واحدة أو طبّق منطق يمنع التكرار (مثل كود يمنع تنفيذ الحدث إلا مرة واحدة في نفس الوقت).

عدم إنشاء أكثر من جلسة تسجيل في نفس الوقت (مثلاً أكثر من MediaRecorder أو أكثر من stream)؛ يجب أن يكون هناك حالة واضحة: إما "يسجّل الآن" أو "متوقف".

عندما يكون الزر في وضع "استماع مستمر"، يتم التعامل مع التدفق بشكل متزن بدون تكرار إرسال البيانات مرتين أو بشكل متسارع.

الهدف: عند الضغط على زر الميكروفون:

يبدأ تسجيل واحد فقط، بالسرعة العادية.

وعند الضغط مرة أخرى (أو حسب التصميم الحالي)، يتوقف التسجيل مرة واحدة فقط.

عدم ظهور أي سلوك مزدوج أو متكرر في النص الناتج.

8️⃣ خطوات نهائية واختبار

نفّذ جميع التعديلات المطلوبة في main.py و Dockerfile وملفات الواجهة الأمامية (HTML/CSS/JS) الخاصة بالموقع، مع الحفاظ على هوية التصميم الحالية.

أضف تعليقات مختصرة داخل الكود (بالعربية) تشرح التعديلات المهمة، خصوصًا في:

منطق قص يوتيوب وتحميله.

منطق اختيار الجودة ونوع التحميل.

تحسينات واجهة الموبايل والتابلت.

إصلاح القائمة الجانبية.

إصلاح زر الميكروفون.

بعد الانتهاء، شغّل التطبيق داخل Replit وجرب الآتي:

قص مقطع من يوتيوب بجودات مختلفة، مرة كفيديو ومرة كصوت فقط.

فتح الموقع من منظور موبايل/تابلت والتأكد أن الأقسام تظهر بشكل صحيح.

الضغط على زر القائمة الجانبية في الموبايل والتأكد أنه يفتح ويُغلق كما ينبغي.

تجربة زر الميكروفون (التسجيل العادي والاستماع المستمر) والتأكد أنه لا يسجّل إلا مرة واحدة ولا يكرر التسجيل أو يسرّعه.

أريد تنفيذ كل هذه التغييرات داخل المشروع الحالي بشكل عملي وكامل، مع الحفاظ على تجربة المستخدم النهائية وتحسين الأداء والثبات قدر الإمكان.