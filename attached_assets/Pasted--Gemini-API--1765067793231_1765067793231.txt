أريدك أن تعيد تنظيم طريقة استدعاء Gemini في المشروع بالكامل بحيث:

نحافظ على مفاتيح الـ API لأطول فترة ممكنة.

نقلل الاستهلاك اليومي بذكاء.

لا تتعطل أي أداة من أدوات الموقع.

لا تتغير تجربة المستخدم إلا في حالة تخطي الحدود المنطقية للاستخدام.

نفّذ المطلوب بالتفصيل التالي:

1️⃣ توحيد نقطة استدعاء Gemini (Centralized Logic)

اجمع كل الأماكن في الكود التي يتم فيها استدعاء Gemini (نص، رؤية، تحويل صوت، إلخ).

أنشئ طبقة واحدة (وظائف/دوال مركزية) تمرّ من خلالها كل طلبات Gemini بدل تكرار منطق الاستدعاء في أكثر من مكان.

هذه الطبقة هي المكان الوحيد الذي:

يختار المفتاح (API key)

يطبق الـ retries

يطبّق أي حدود (limits) أو قيود

يكتب الـ logs

لا تغيّر منطق الأدوات نفسها (routes والـ endpoints)؛ فقط اجعلها تعتمد على هذه الطبقة الموحدة لاستدعاء Gemini.

2️⃣ تقليل الـ retries وحماية المفاتيح من الحرق

تأكد أن منطق الاستدعاء لا يقوم بالدوران على عدة مفاتيح لكل طلب واحد إلا عند الضرورة القصوى.

المطلوب:

لكل طلب من المستخدم:

جرب مفتاحًا واحدًا فقط في البداية.

إذا حدث خطأ من نوع quota / rate limit / 429:

جرّب مفتاحًا آخر مرة واحدة فقط كـ retry نهائي.

إذا فشل المفتاح الثاني أيضًا:

لا تكمل الدوران على باقي المفاتيح في نفس الطلب.

أعد للمستخدم رسالة واضحة بأن خدمة الذكاء الاصطناعي مشغولة حاليًا أو أن الحد اليومي تم تجاوزه.

أي خطأ آخر (مثل 400 أو 401 أو 403 أو 500) لا يجب أن يؤدي إلى تجربة مفاتيح أخرى؛ فقط سجّل الخطأ وأعد رسالة مناسبة للمستخدم.

الهدف:
ألا يستهلك طلب واحد من المستخدم أكثر من مفتاحين كحد أقصى، بدلاً من الدوران على كل المفاتيح.

3️⃣ منع استدعاءات Gemini “الخلفية” أو غير الضرورية

تأكد من عدم وجود أي استدعاءات لـ Gemini تتم:

عند تحميل الصفحة فقط، لمجرد “اختبار” أو “تهيئة”.

في أي loop أو job مستمر.

في أي دوال debug أو logging قديمة.

يجب أن يتم استدعاء Gemini فقط عندما:

المستخدم يضغط زر تنفيذ واضح (تحويل، تحليل، تفريغ صوت، إلخ).

إذا وجدت أي استدعاء آلي لا يعتمد على فعل صريح من المستخدم:

عطّله أو أزله، مع التأكد أن وظيفة الأداة الأصلية لا تتعطل.

4️⃣ إضافة حدود استخدام منطقية لكل جلسة / لكل مستخدم

أضف طبقة حماية تمنع إساءة الاستخدام أو الاستهلاك العشوائي، بدون تخريب الأدوات.

أمثلة لما يجب تنفيذه (اختر ما يناسب الكود الحالي أو نفّذ مزيجًا منها):

حدود لكل جلسة (per session أو per IP):

حد أقصى لعدد طلبات Gemini لكل جلسة خلال فترة زمنية (مثل 10–20 طلب لكل 15–30 دقيقة).

عند وصول المستخدم للسقف:

أعد له رسالة أن الحد المسموح به مؤقتًا تم بلوغه، واطلب منه الانتظار قليلًا.

حدود لحجم الطلب:

في أدوات تحويل الصوت/الفيديو:

ضع حدًا أقصى لمدة الملف (مثل 10–15 دقيقة) إن لم يكن موجودًا بالفعل.

إذا تجاوز المستخدم الحد، أعطه رسالة تقول إن المدة كبيرة جدًا ويُنصح بتقسيم الملف.

تأكد أن هذه الحدود:

لا توقف الأدوات في الاستخدام الطبيعي.

فقط تحمي النظام من الطلبات المفرطة أو الكبيرة جدًا.

5️⃣ اختيار نماذج أخف عند الإمكان

في الأماكن التي لا تحتاج دقة عالية جدًا:

استخدم نموذج Gemini الأخف (مثل إصدارات flash) بدل النماذج الأثقل، لتقليل استهلاك الكوتا.

أمثلة:

تلخيص نصوص / تحليل بسيط / تعليقات → استخدم نموذج أخف.

المهام الثقيلة جدًا فقط (مثل تفريغ ملفات طويلة جدًا أو تحليل معقّد) يمكنها الاعتماد على النموذج الأقوى إذا كان ذلك ضروريًا.

احرص على أن هذا التغيير لا يكسر أي أداة؛ فقط عدّل اسم النموذج في مواضع الاستخدام المناسبة.

6️⃣ إضافة Logging واضح لمراقبة الاستهلاك

أضف نظام لوج بسيط لكن واضح في الطبقة الموحدة لاستدعاء Gemini:

عند كل استدعاء:

سجّل رقم المفتاح المستخدم (index أو اسم منطقي، وليس قيمة المفتاح).

نوع العملية (نص، رؤية، صوت، إلخ).

إذا كانت المحاولة الأولى أو retry.

إذا حدث خطأ، سجّل نوعه (429, quota, rate limit, 400…).

الهدف:

أن نتمكن لاحقًا من فهم:

أي الأدوات تستهلك الكوتا أكثر؟

هل هناك طلبات متكررة بشكل مبالغ فيه؟

هل هناك مفاتيح تضرب في quota أسرع من غيرها؟

تأكد أن الـ logs لا تحتوي أبدًا على قيمة مفتاح الـ API نفسه.

7️⃣ سلوك واضح عند استنفاد الكوتا أو نفاد المفاتيح

إذا وصلت الحالة إلى أن جميع المفاتيح الفعّالة أصبحت مستنفدة لليوم أو في فترة زمنية محددة:

لا تدع التطبيق ينهار أو يرمي استثناء غير مفهوم.

بدلاً من ذلك:

أعد للمستخدم رسالة واضحة بالعربي تقول مثلًا:

“تم استهلاك الحد المتاح من خدمة الذكاء الاصطناعي مؤقتًا. الرجاء المحاولة لاحقًا أو تجربة أداة أخرى.”

اجعل الأدوات الأخرى التي لا تعتمد على Gemini (مثل التحميل أو القص أو التحويل البسيط) تعمل بشكل طبيعي بدون تعطيل.

8️⃣ عدم كسر أي أداة موجودة حاليًا

لا تحذف أي route أو وظيفة من وظائف الأدوات.

لا تغيّر شكل الـ responses إلا في حالة الخطأ المتعلق بالكوتا/المفاتيح كما تم وصفه.

تأكد بعد تنفيذ كل التعديلات من:

أداة تحويل الصوت إلى نص تعمل كالمعتاد طالما هناك كوتا.

أداة تحويل الفيديو إلى نص تعمل ضمن الحدود الزمنية مع رسالة واضحة عند تجاوز الحد.

باقي أدوات الموقع تعمل بدون تغيير سلوكها الأساسي.

أي تغيير تقوم به يجب أن يكون:

محصورًا في طبقة استدعاء Gemini.

أو في منطق الحدود (limits) والـ logging فقط.

9️⃣ اختبار نهائي

بعد تنفيذ التعديلات:

جرّب استخدام الأدوات عدة مرات من نفس المتصفح (نفس الجلسة):

تأكد أن الأدوات تعمل بشكل طبيعي في الاستخدام المعتاد.

تأكد أن الحدود لا تتدخل إلا عند الاستخدام الزائد أو الملفات الكبيرة جدًا.

جرّب سيناريوهات:

طلبات كثيرة متتالية → يجب أن تظهر رسالة الحد بدلاً من احتراق المفاتيح.

تعمد إرسال ملف أكبر من الحد المطلوب → تظهر رسالة توضيح السبب للمستخدم.

استنفاد الكوتا (يمكن محاكاته بإجبار الكود على اعتبار كل المفاتيح مستنفدة) → تظهر رسالة ودية بدون سقوط التطبيق.

أريد في النهاية:

نفس الأدوات الحالية تعمل كما هي للمستخدم العادي.

لكن مع حماية ذكية تقلل استهلاك مفاتيح Gemini، وتمنع الدوران على كل المفاتيح في طلب واحد، وتمنع الاستدعاءات غير الضرورية، مع لوج واضح يساعد على متابعة الاستخدام اليومي للكوتا.