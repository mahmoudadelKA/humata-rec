أريدك أن تراجع وتعدّل مشروعي الحالي (تطبيق Flask في الملف main.py + Dockerfile) ليكون أخف بكثير في استهلاك الذاكرة وأعلى في الاعتمادية، مع تحسين شامل لأداة قص فيديو يوتيوب، مع إضافة ميزة اختيار جودة الفيديو ونوع التحميل (فيديو أو صوت فقط) للمستخدم، مع الحفاظ على نفس شكل الموقع وتجربة الاستخدام قدر الإمكان.

التعديلات المطلوبة بالتفصيل:

1️⃣ ضبط Dockerfile و Gunicorn

أبقِ جميع إعدادات Dockerfile كما هي (قاعدة الصورة، تنصيب ffmpeg و tesseract، تثبيت الحزم من requirements.txt).

تأكد أن WORKDIR مضبوط على ‎/app‎، ويتم نسخ requirements.txt ثم باقي ملفات المشروع كما هو حاليًا.

احذف أي سطر EXPOSE لبورت ثابت إن وجد، لأن الخدمة تعمل على Render ويجب الاعتماد فقط على متغيّر البيئة PORT.

عدّل سطر CMD بحيث:

يتم تشغيل Gunicorn على main:app.

يربط على 0.0.0.0 باستخدام قيمة PORT من متغيّر البيئة (بدون أرقام ثابتة).

يكون عدد الـ workers = 1.

يكون عدد الـ threads = 1.

timeout = 1800 ثانية.

الهدف: تشغيل نسخة واحدة من التطبيق لتقليل استهلاك الذاكرة مع السماح بالطلبات الطويلة.

2️⃣ تحسين شامل لأداة قص فيديو يوتيوب + اختيار الجودة + نوع التحميل

أريد إعادة تصميم منطق أداة قص يوتيوب في backend (main.py) مع الحفاظ على نفس الواجهة الأمامية قدر الإمكان، مع إضافة:

اختيار الجودة.

اختيار نوع التحميل (فيديو أو صوت فقط).

جلب الجودات المتاحة من يوتيوب.

أ) دالة للحصول على الجودات المتاحة من يوتيوب

أنشئ دالة Backend تستخدم yt_dlp فقط لجلب قائمة بالجودات/الفورمات المتاحة للفيديو المطلوب (دون تحميل الفيديو نفسه).

الدالة يجب أن:

تستقبل رابط اليوتيوب.

تستدعي yt_dlp لاسترجاع قائمة الفورمات المتاحة.

تُرجع قائمة مبسّطة يمكن إرسالها للواجهة الأمامية، مثلاً:

دقة الفيديو (مثل 360p, 480p, 720p, 1080p)

نوع الفورمات (فيديو+صوت، فيديو فقط، صوت فقط)

حجم تقريبي إن أمكن

تستخدم cookies.txt إن كان موجودًا لتفادي مشاكل 403.

أنشئ route في Flask (يمكن أن يكون مستخدمًا بالفعل مع زر "جلب المعلومات" في الواجهة) يعيد هذه القائمة بصيغة JSON، ليتم من خلاله تعبئة قائمة الجودات في الواجهة الأمامية.

ب) دالة تحميل فيديو يوتيوب محسّنة

أنشئ دالة مسؤولة عن تحميل الفيديو من يوتيوب إلى ملف مؤقت على القرص، تعتمد على yt_dlp.

الدالة يجب أن:

تستقبل: رابط الفيديو، الجودة المطلوبة (مثل 360p/480p/720p/1080p أو معرف الفورمات المناسب)، ونوع التحميل (video أو audio).

تستخدم format المناسب في yt_dlp بناءً على:

إذا كان النوع video: تحميل mp4 بأقرب فورمات للجودة المطلوبة (أولوية لفيديو+صوت موحّد).

إذا كان النوع audio: تحميل أفضل فورمات صوت (مثلاً m4a) مع حجم معقول؛ يمكن لاحقًا تحويله إلى mp3 عند الحاجة بواسطة ffmpeg.

تمنع تحميل playlists.

تستخدم cookies.txt إن وجد.

تحفظ النتيجة في ملف داخل مجلد مؤقت باستخدام tempfile، وتُرجع المسار الكامل للملف.

الهدف: تحميل ملف واحد بالجودة المطلوبة دون تحميل البيتات في الذاكرة.

ج) دالة قص الفيديو/الصوت بالاعتماد على ffmpeg فقط

أنشئ دالة مساعدة للقص تعمل على مستوى الملفات فقط، بدون تحميل الفيديو كاملًا في كائن Python كبير.

الدالة تستقبل:

مسار الملف المدخَل الذي تم تحميله.

وقت البداية.

وقت النهاية.

نوع التحميل (video أو audio).

استخدم ffmpeg عبر subprocess، مع مراعاة:

استخدام ss و to لقص الجزء المطلوب.

إذا كان النوع video:

استخدم ‎-c copy‎ قدر الإمكان للقص بدون إعادة ترميز، لتقليل استهلاك المعالج والذاكرة.

إذا كان النوع audio:

استخراج الصوت فقط من الفيديو/الملف، باستخدام خيارات مثل ‎-vn‎ (إلغاء الفيديو) مع ترميز صوت مناسب (مثلاً mp3 أو m4a) بجودة معقولة وخفيفة.

حفظ الناتج في ملف مؤقت جديد (mp4 للفيديو، وامتداد صوت مناسب للنوع audio).

إعادة مسار الملف الناتج.

د) تعديل الراوت الرئيسية لأداة القص

عدّل الراوت التي تتعامل مع قص فيديو يوتيوب بحيث:

تستقبل من الطلب:

رابط يوتيوب (كما هو حاليًا).

وقت البداية ووقت النهاية (بنفس التنسيق الحالي).

الجودة المختارة من المستخدم (القيمة التي تأتي من الـ Select في الواجهة).

نوع التحميل (video أو audio) من قائمة جديدة (مثلاً "تحميل مقطع فيديو" أو "تحميل مقطع صوت فقط").

تستدعي:

دالة تحميل الفيديو مع تمرير الجودة والنوع.

دالة القص مع تمرير المسار ووقت البداية والنهاية والنوع.

تُرسل file الناتج للمستخدم كـ attachment:

mp4 عند اختيار video.

امتداد صوت مناسب عند اختيار audio (مثلاً mp3).

تضيف منطق تنظيف للملفات المؤقتة بعد إرسال الرد للمستخدم باستخدام after_this_request:

حذف ملف الفيديو الأصلي الذي تم تحميله.

حذف ملف المقطع النهائي بعد الإرسال.

تضيف logging واضح للخطوات:

بدء جلب الجودات (إن وُجد).

بدء التحميل من يوتيوب، الانتهاء من التحميل.

بدء القص، الانتهاء من القص.

حذف الملفات المؤقتة.

هـ) تعديل الواجهة الخلفية لدعم اختيار الجودة والنوع

حافظ على تصميم الواجهة كما هو، لكن:

عند الضغط على "جلب المعلومات"، يُرسَل طلب إلى الراوت التي تجلب الجودات المتاحة من يوتيوب، ويتم ملء قائمة الجودة في الواجهة بناءً على الرد.

أضف في الواجهة اختيارًا لنوع التحميل (Video / Audio Only) مرتبط بحقول الطلب في الـ backend.

على مستوى الـ backend:

تأكد من التعامل مع الحقول الجديدة (quality, download_type).

استخدم قيمة افتراضية مناسبة في حالة عدم إرسال الجودة أو النوع (مثل 480p و video).

3️⃣ تحسين استهلاك الذاكرة في باقي الأدوات

راجع الأدوات الأخرى التي تستخدم ملفات صوت أو فيديو أو صور، وقلّل قدر الإمكان من الاحتفاظ بكائنات كبيرة في الذاكرة.

في أي مكان تستخدم فيه AudioSegment أو صور كبيرة:

استخدم الملفات على القرص بدلًا من الاحتفاظ بالبيانات كـ Bytes أو base64 في المتغيرات.

تخلّص من الكائنات الكبيرة مباشرة بعد الانتهاء منها، حتى لو عن طريق حذف المرجع واستدعاء gc إذا لزم الأمر.

تجنّب تخزين ملفات كبيرة كسلاسل نصية base64 إلا لو كان ضروريًا جدًا، والأفضل إرسالها كملفات مباشرة للمستخدم.

استمر في استخدام المجلد المؤقت للملفات الكبيرة، مع تنظيفها بعد كل طلب.

4️⃣ الحفاظ على سلوك الموقع

لا تغيّر شكل الواجهة الأمامية أو أسماء المسارات أو الحقول إلا بقدر ما يلزم لدعم:

اختيار الجودة

اختيار نوع التحميل

تأكد أن:

أداة قص يوتيوب تعمل كما كانت لكن مع الخيارات الجديدة للجودة والنوع.

لا يتغير سلوك الأدوات الأخرى من وجهة نظر المستخدم إلا فيما يخص تحسين الأداء وتقليل الأخطاء.

5️⃣ في النهاية

نفّذ التعديلات في main.py و Dockerfile وملفات القوالب أو الجافاسكربت الخاصة بأداة قص اليوتيوب فقط بالقدر اللازم لدعم الميزات الجديدة.

أضف تعليقات داخل الكود (بالعربية) تشرح باختصار التعديلات المهمة وكيفية عمل:

جلب الجودات.

اختيار الجودة والنوع.

تحميل الفيديو/الصوت.

القص وتنظيف الملفات.

شغّل التطبيق داخل Replit بعد التعديلات، واختبر:

قص مقطع فيديو بجودات مختلفة.

تحميل نفس المقطع كصوت فقط.

التأكد من عدم حصول أعطال في الذاكرة أثناء الاستخدام العادي.